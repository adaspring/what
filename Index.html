<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Compatibility Analyzer</title>
    <style>
        :root {
            --primary: #2196F3;
            --warning: #ff9800;
            --danger: #f44336;
        }
        body { font-family: Arial, sans-serif; margin: 2rem; }
        .upload-section { margin-bottom: 2rem; }
        .report { margin-top: 2rem; padding: 1rem; background: #f5f5f5; }
        .browser-card { 
            background: white; 
            padding: 1rem; 
            margin: 1rem 0; 
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-bar {
            height: 20px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .feature-list { margin-top: 1rem; }
        .feature-item { margin: 0.5rem 0; padding: 0.5rem; background: #fff; }
        #deviceResults { margin-top: 2rem; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/css-tree@2.1.1/dist/csstree.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/acorn@8.10.0/dist/acorn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/acorn-walk@8.2.0/dist/walk.min.js"></script>
</head>
<body>
    <h1>Code Compatibility Analyzer</h1>
    
    <div class="upload-section">
        <input type="file" id="htmlFile" accept=".html" placeholder="Upload HTML">
        <input type="file" id="cssFile" accept=".css" placeholder="Upload CSS">
        <input type="file" id="jsFile" accept=".js" placeholder="Upload JavaScript">
        <button onclick="analyzeCode()">Analyze Code</button>
    </div>

    <div class="report" id="report" style="display: none;">
        <h3>Compatibility Report</h3>
        <div id="overallScore"></div>
        <h4>Browser Support</h4>
        <div id="browserResults"></div>
        <h4>Device Support</h4>
        <div id="deviceResults"></div>
        <h4>Detected Features</h4>
        <div id="featureResults"></div>
    </div>

    <script>
        let caniuseData = null;
        const browserMarketShare = {
            'chrome': { 
                versions: {'120': 35, '119': 25, '118': 20},
                devices: ['desktop', 'android'] 
            },
            'safari': {
                versions: {'17': 40, '16': 30, '15': 20},
                devices: ['ios', 'macos']
            },
            'firefox': {
                versions: {'120': 50, '119': 30},
                devices: ['desktop']
            },
            'edge': {
                versions: {'120': 60, '119': 30},
                devices: ['desktop', 'windows']
            }
        };

        const deviceCategories = {
            'mobile': ['ios', 'android'],
            'desktop': ['windows', 'macos', 'linux'],
            'tablet': ['ios', 'android']
        };

        async function loadCaniuseData() {
            const response = await fetch('https://cdn.jsdelivr.net/npm/caniuse-db@1.0.30001428/data.json');
            caniuseData = await response.json();
        }

        async function analyzeCode() {
            const report = document.getElementById('report');
            report.style.display = 'block';
            
            const [html, css, js] = await Promise.all([
                readFile(document.getElementById('htmlFile')),
                readFile(document.getElementById('cssFile')),
                readFile(document.getElementById('jsFile'))
            ]);

            const cssFeatures = await detectFeatures(css, 'css');
            const jsFeatures = await detectFeatures(js, 'js');
            const allFeatures = [...cssFeatures, ...jsFeatures];
            
            const compatibility = calculateCompatibility(allFeatures);
            const deviceScores = calculateDeviceScore(compatibility);
            
            renderReport(compatibility, allFeatures, deviceScores);
        }

        function readFile(input) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                input.files[0] ? reader.readAsText(input.files[0]) : resolve('');
            });
        }

        async function detectFeatures(code, type) {
            const features = new Set();
            
            if (type === 'css') {
                try {
                    const ast = csstree.parse(code, {
                        positions: true,
                        parseValue: true
                    });
                    
                    csstree.walk(ast, (node) => {
                        if (node.type === 'Declaration') {
                            if (node.property === 'display' && 
                                csstree.generate(node.value) === 'grid') {
                                features.add('css-grid');
                            }
                            if (node.property.startsWith('--')) {
                                features.add('css-variables');
                            }
                        }
                    });
                } catch (e) {
                    console.error('CSS Parse Error:', e);
                }
            }
            
            if (type === 'js') {
                try {
                    const ast = acorn.parse(code, {
                        ecmaVersion: 2022,
                        locations: true
                    });

                    acornWalk.full(ast, (node) => {
                        if (node.type === 'ArrowFunctionExpression') {
                            features.add('arrow-functions');
                        }
                        if (node.type === 'CallExpression' &&
                            node.callee.name === 'fetch') {
                            features.add('fetch-api');
                        }
                    });
                } catch (e) {
                    console.error('JS Parse Error:', e);
                }
            }
            
            return Array.from(features);
        }

        function calculateCompatibility(features) {
            const browserSupport = {};

            features.forEach(feature => {
                const data = caniuseData.data[feature];
                if (!data) return;

                Object.entries(data.stats).forEach(([browser, versions]) => {
                    const supportPercentage = calculateVersionSupport(browser, versions);
                    browserSupport[browser] = (browserSupport[browser] || 0) + supportPercentage;
                });
            });

            Object.keys(browserSupport).forEach(browser => {
                browserSupport[browser] = (browserSupport[browser] / features.length).toFixed(1);
            });

            return browserSupport;
        }

        function calculateVersionSupport(browser, versions) {
            let total = 0;
            Object.entries(versions).forEach(([version, status]) => {
                if (status.startsWith('y') && browserMarketShare[browser]?.versions[version]) {
                    total += browserMarketShare[browser].versions[version];
                }
            });
            return total;
        }

        function calculateDeviceScore(browserSupport) {
            const deviceScores = {};
            
            Object.entries(deviceCategories).forEach(([category, devices]) => {
                let total = 0;
                let count = 0;
                
                Object.entries(browserSupport).forEach(([browser, score]) => {
                    const browserInfo = browserMarketShare[browser];
                    if (browserInfo?.devices.some(d => devices.includes(d))) {
                        total += parseFloat(score);
                        count++;
                    }
                });
                
                deviceScores[category] = count > 0 ? (total / count).toFixed(1) : 0;
            });
            
            return deviceScores;
        }

        function renderReport(compatibility, features, deviceScores) {
            const overall = Object.values(compatibility).reduce((a, b) => a + parseFloat(b), 0) / Object.values(compatibility).length;
            document.getElementById('overallScore').innerHTML = `
                <h4>Overall Compatibility: ${overall.toFixed(1)}%</h4>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${overall}%; background: ${getColor(overall)}"></div>
                </div>
            `;

            document.getElementById('browserResults').innerHTML = Object.entries(compatibility).map(([browser, score]) => `
                <div class="browser-card">
                    <h4>${browser.toUpperCase()}</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${score}%; background: ${getColor(score)}"></div>
                    </div>
                    <div>${score}% supported</div>
                </div>
            `).join('');

            document.getElementById('deviceResults').innerHTML = Object.entries(deviceScores).map(([device, score]) => `
                <div class="browser-card">
                    <h4>${device.toUpperCase()}</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${score}%; background: ${getColor(score)}"></div>
                    </div>
                    <div>${score}% supported</div>
                    <small>Platforms: ${deviceCategories[device].join(', ')}</small>
                </div>
            `).join('');

            document.getElementById('featureResults').innerHTML = `
                <div class="feature-list">
                    ${features.map(f => `<div class="feature-item">${f}</div>`).join('')}
                </div>
            `;
        }

        function getColor(percentage) {
            if (percentage > 75) return '#2196F3';
            if (percentage > 50) return '#ff9800';
            return '#f44336';
        }

        // Initialize CanIUse data
        loadCaniuseData();
    </script>
</body>
</html>
